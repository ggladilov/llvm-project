# add new remote to git repository
git remote add <name> <url>
# change existing remote link
git remote set-url <name> <url>

# clone without history
git clone --depth=1 https://github.com/llvm/llvm-project.git
mkdir -p ./llvm-project/build && cd ./llvm-project/build
# configure project to build clang for x86 only with dynamic libraries
cmake                                \
    -D CMAKE_BUILD_TYPE=Debug        \
    -D LLVM_ENABLE_PROJECTS="clang"  \
    -D LLVM_TARGETS_TO_BUILD=X86     \
    -D LLVM_LINK_LLVM_DYLIB=true     \
    ../llvm
# build everything with 1 thread
cmake --build . -- -j1

export LLVM_DIR=`pwd`

$LLVM_DIR/bin/clang++ \
    -c add_zero.cpp   \
    -O0               \
    -S                \
    -emit-llvm        \
    -o /dev/stdout | sed 's/ optnone//g' > add_zero_wout_optnone.ll

$LLVM_DIR/bin/lli add_zero_wout_optnone.ll 1 2 3 4 ; echo $?

$LLVM_DIR/bin/opt                                \
    -enable-new-pm=0                             \
    -load $LLVM_DIR/lib/LLVMRemoveAddWithZero.so \
    -remove-add-with-zero                        \
    -S < add_zero_wout_optnone.ll -o add_zero_wout_optnone_optimized.ll

$LLVM_DIR/bin/lli add_zero_wout_optnone_optimized.ll 1 2 3 4 ; echo $?

$LLVM_DIR/bin/clang++ \
    -c add_zero.cpp   \
    -O0               \
    -S                \
    -emit-llvm        \
    -o add_zero.ll

$LLVM_DIR/bin/lli add_zero.ll 1 2 3 4 ; echo $?

$LLVM_DIR/bin/opt                                 \
    -passes=remove-add-with-zero-new-pass-manager \
    -S < add_zero.ll -o add_zero_optimized.ll

$LLVM_DIR/bin/lli add_zero_optimized.ll 1 2 3 4 ; echo $?
